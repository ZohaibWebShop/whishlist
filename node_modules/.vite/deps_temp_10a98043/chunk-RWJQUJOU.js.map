{
  "version": 3,
  "sources": ["../../@shopify/app-bridge-core/MessageTransport.js"],
  "sourcesContent": ["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.createTransportListener = exports.fromWindow = exports.fromFrame = exports.Context = void 0;\nvar Error_1 = require(\"./actions/Error\");\nvar validator_1 = require(\"./actions/validator\");\nvar types_1 = require(\"./client/types\");\nvar collection_1 = require(\"./util/collection\");\nvar env_1 = require(\"./util/env\");\nvar Context;\n(function (Context) {\n    Context[\"Modal\"] = \"Modal\";\n    Context[\"Main\"] = \"Main\";\n})(Context = exports.Context || (exports.Context = {}));\n/**\n * Create a MessageTransport from a Frame.\n * @remarks\n * Used on the host-side to create a postMessage MessageTransport.\n * @beta\n */\nfunction fromFrame(frame, localOrigin, context) {\n    var handlers = [];\n    var host = frame.host, frameWindow = frame.window;\n    if (!host) {\n        throw Error_1.fromAction('App frame is undefined', Error_1.AppActionType.WINDOW_UNDEFINED);\n    }\n    if (env_1.isUnframed && window.MobileWebView) {\n        Object.assign(window.MobileWebView, {\n            postMessageToIframe: function (message, origin) {\n                frameWindow === null || frameWindow === void 0 ? void 0 : frameWindow.postMessage(message, origin);\n                if (isDispatchAction(message)) {\n                    host.postMessage(JSON.stringify(message.payload), location.origin);\n                }\n            },\n            updateIframeUrl: function (newUrl) {\n                var currentWindowLocation = window.location;\n                var frameWindowLocation = (frame.window || {}).location;\n                try {\n                    var newUrlOrigin = new URL(newUrl).origin;\n                    if (newUrlOrigin === localOrigin && frameWindowLocation) {\n                        frameWindowLocation.replace(newUrl);\n                    }\n                    else {\n                        currentWindowLocation.href = newUrl;\n                    }\n                }\n                catch (_) {\n                    // Noop\n                }\n            },\n        });\n    }\n    host.addEventListener('message', function (event) {\n        if (event.source === host || !validator_1.isAppMessage(event)) {\n            return;\n        }\n        if (event.origin !== localOrigin) {\n            var errorMessage = \"Message origin '\" + event.origin + \"' does not match app origin '\" + localOrigin + \"'.\";\n            var payload = Error_1.invalidOriginAction(errorMessage);\n            var message = {\n                type: 'dispatch',\n                payload: payload,\n            };\n            frameWindow === null || frameWindow === void 0 ? void 0 : frameWindow.postMessage(message, event.origin);\n            return;\n        }\n        if (env_1.isUnframed && window.MobileWebView) {\n            var payload = JSON.stringify({\n                id: 'unframed://fromClient',\n                origin: localOrigin,\n                data: event.data,\n            });\n            window.MobileWebView.postMessage(payload);\n            return;\n        }\n        for (var _i = 0, handlers_1 = handlers; _i < handlers_1.length; _i++) {\n            var handler = handlers_1[_i];\n            handler(event);\n        }\n    });\n    return {\n        context: context,\n        localOrigin: localOrigin,\n        frameWindow: frameWindow,\n        hostFrame: host,\n        dispatch: function (message) {\n            frameWindow === null || frameWindow === void 0 ? void 0 : frameWindow.postMessage(message, localOrigin);\n        },\n        subscribe: function (handler) {\n            return collection_1.addAndRemoveFromCollection(handlers, handler);\n        },\n    };\n}\nexports.fromFrame = fromFrame;\n/**\n * Create a MessageTransport from a parent window.\n * @remarks\n * Used on the client-side to create a postMessage MessageTransport.\n * @internalremarks\n * In unframed mode, message should be dispatched via MobileWebView.postMessage instead of postMessage.\n * @beta\n */\nfunction fromWindow(contentWindow, localOrigin) {\n    var handlers = [];\n    if (typeof window !== undefined) {\n        window.addEventListener('message', function (event) {\n            if ((window === contentWindow && !env_1.isUnframed) ||\n                event.source !== contentWindow ||\n                !(validator_1.isAppBridgeAction(event.data.payload) || validator_1.isAppMessage(event))) {\n                return;\n            }\n            for (var _i = 0, handlers_2 = handlers; _i < handlers_2.length; _i++) {\n                var handler = handlers_2[_i];\n                handler(event);\n            }\n        });\n    }\n    return {\n        localOrigin: localOrigin,\n        hostFrame: contentWindow,\n        dispatch: function (message) {\n            var _a;\n            if (!((_a = message.source) === null || _a === void 0 ? void 0 : _a.host)) {\n                return;\n            }\n            if (env_1.isUnframed && window && window.MobileWebView) {\n                var payload = JSON.stringify({\n                    id: 'unframed://fromClient',\n                    origin: localOrigin,\n                    data: message,\n                });\n                window.MobileWebView.postMessage(payload);\n                return;\n            }\n            var messageOrigin = new URL(\"https://\" + message.source.host).origin;\n            contentWindow.postMessage(message, messageOrigin);\n        },\n        subscribe: function (handler) {\n            return collection_1.addAndRemoveFromCollection(handlers, handler);\n        },\n    };\n}\nexports.fromWindow = fromWindow;\nfunction createTransportListener() {\n    var listeners = [];\n    var actionListeners = {};\n    function createSubscribeHandler(dispatcher) {\n        function subscribe() {\n            if (arguments.length < 2) {\n                // eslint-disable-next-line prefer-rest-params\n                return collection_1.addAndRemoveFromCollection(listeners, { callback: arguments[0] });\n            }\n            // eslint-disable-next-line prefer-rest-params\n            var _a = Array.from(arguments), type = _a[0], callback = _a[1], id = _a[2];\n            var actionCallback = { callback: callback, id: id };\n            var payload = { type: type, id: id };\n            if (!Object.prototype.hasOwnProperty.call(actionListeners, type)) {\n                actionListeners[type] = [];\n            }\n            if (dispatcher) {\n                dispatcher(types_1.MessageType.Subscribe, payload);\n            }\n            return collection_1.addAndRemoveFromCollection(actionListeners[type], actionCallback, function () {\n                if (dispatcher) {\n                    dispatcher(types_1.MessageType.Unsubscribe, payload);\n                }\n            });\n        }\n        return subscribe;\n    }\n    return {\n        createSubscribeHandler: createSubscribeHandler,\n        handleMessage: function (message) {\n            listeners.forEach(function (listener) { return listener.callback(message); });\n        },\n        handleActionDispatch: function (_a) {\n            var type = _a.type, payload = _a.payload;\n            var hasCallback = false;\n            if (Object.prototype.hasOwnProperty.call(actionListeners, type)) {\n                for (var _i = 0, _b = actionListeners[type]; _i < _b.length; _i++) {\n                    var listener = _b[_i];\n                    var id = listener.id, callback = listener.callback;\n                    var matchId = payload && payload.id === id;\n                    if (matchId || !id) {\n                        callback(payload);\n                        hasCallback = true;\n                    }\n                }\n            }\n            return hasCallback;\n        },\n    };\n}\nexports.createTransportListener = createTransportListener;\nfunction isDispatchAction(message) {\n    return (message !== null &&\n        typeof message === 'object' &&\n        !Array.isArray(message) &&\n        message.type === 'dispatch' &&\n        typeof message.payload === 'object');\n}\n"],
  "mappings": "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",
  "names": ["Context"]
}
